<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOAA Data Lake - Live Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            color: #2ecc71;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            flex: 1;
            padding: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-button.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-change {
            font-size: 0.85em;
            margin-top: 10px;
            opacity: 0.9;
        }

        .pond-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .pond-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .pond-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-3px);
        }

        .pond-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pond-icon {
            font-size: 2em;
        }

        .pond-status {
            font-size: 0.85em;
            padding: 5px 12px;
            border-radius: 20px;
            background: #2ecc71;
            color: white;
        }

        .pond-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 10px;
        }

        .pond-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: #666;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 50px 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 30px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            font-size: 2em;
            border: none;
            background: none;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .data-sample {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .image-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .image-card img {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        .map-container {
            height: 500px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .image-status {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .refresh-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .timestamp {
            color: #999;
            font-size: 0.9em;
        }

        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä NOAA Data Lake - Live Dashboard</h1>
            <div class="status">
                <span class="status-dot"></span>
                <span id="systemStatus">System Operational</span>
            </div>
            <p style="margin-top: 15px;">
                <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh All</button>
                <span class="timestamp">Last Updated: <span id="lastUpdate">Loading...</span></span>
            </p>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('overview', this)">üìä System Overview</button>
                <button class="tab-button" onclick="showTab('ponds', this)">üóÇÔ∏è Data Ponds</button>
                <button class="tab-button" onclick="showTab('images', this)">üó∫Ô∏è Maps & Images</button>
            </div>

            <!-- System Overview Tab -->
            <div id="overview" class="tab-content active">
                <h2 style="margin-bottom: 20px;">Real-Time System Metrics</h2>
                <div class="stats-grid" id="systemStats">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading system metrics...</p>
                    </div>
                </div>

                <div class="info-box">
                    <strong></strong>üî¥ LIVE DATA:</strong> All metrics are pulled in real-time from AWS.
                    Watch the record counts increase as data ingests!
                </div>
            </div>

            <!-- Data Ponds Tab -->
            <div id="ponds" class="tab-content">
                <h2 style="margin-bottom: 20px;">Active Data Ponds</h2>
                <p style="margin-bottom: 20px; color: #666;">Click any pond to view detailed metrics and recent data samples</p>
                <div class="pond-grid" id="pondsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading ponds...</p>
                    </div>
                </div>
            </div>

            <!-- Maps & Images Tab -->
            <div id="images" class="tab-content">
                <h2 style="margin-bottom: 20px;">üó∫Ô∏è Live Map & Image Preview</h2>

                <div class="info-box">
                    <strong></strong>‚úÖ PROOF OF CONCEPT:</strong> These images are loaded directly from NOAA servers using
                    metadata from our data lake. This proves frontend applications can display maps and radar imagery!
                </div>

                <div class="image-preview">
                    <div class="image-card">
                        <h3>üå©Ô∏è Boston Radar (KBOX)</h3>
                        <p>Live NEXRAD radar loop from Ridge Radar system</p>
                        <img id="radarImage" src="https://radar.weather.gov/ridge/standard/KBOX_loop.gif"
                             alt="Boston Radar"
                             onload="imageLoaded('radarImage')"
                             onerror="imageError('radarImage')">
                        <div class="image-status" id="radarImageStatus">Loading...</div>
                    </div>

                    <div class="image-card">
                        <h3>üõ∞Ô∏è Satellite - Northeast</h3>
                        <p>GOES-16 GEOCOLOR composite</p>
                        <img id="satelliteImage" src="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/ne/GEOCOLOR/latest.jpg"
                             alt="Satellite Northeast"
                             onload="imageLoaded('satelliteImage')"
                             onerror="imageError('satelliteImage')">
                        <div class="image-status" id="satelliteImageStatus">Loading...</div>
                    </div>

                    <div class="image-card">
                        <h3>üó∫Ô∏è Surface Analysis</h3>
                        <p>NOAA Weather Prediction Center surface map</p>
                        <img id="surfaceImage" src="https://www.wpc.ncep.noaa.gov/noaa/noaa.gif"
                             alt="Surface Analysis"
                             onload="imageLoaded('surfaceImage')"
                             onerror="imageError('surfaceImage')">
                        <div class="image-status" id="surfaceImageStatus">Loading...</div>
                    </div>

                    <div class="image-card">
                        <h3>üìç Interactive Map</h3>
                        <p>Station locations from our spatial pond data</p>
                        <div id="stationMap" class="map-container"></div>
                        <div class="image-status" id="mapStatus">Initializing map...</div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3>üîó Available Image Endpoints</h3>
                    <div class="data-sample">
# Radar Images (208 stations)
https://radar.weather.gov/ridge/standard/{STATION}_loop.gif
Example: KBOX, KLAX, KJFK, KORD, KATL, KDFW

# Satellite Images (Multiple sectors)
https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/{SECTOR}/GEOCOLOR/latest.jpg
Sectors: ne, se, mw, sw, nw, conus, ak, hi, pr

# WMS Layers (Interactive)
https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows

# Weather Maps
https://www.wpc.ncep.noaa.gov/noaa/noaa.gif
https://www.wpc.ncep.noaa.gov/sfc/namussfc.gif

# Marine Charts
https://charts.noaa.gov/
https://coast.noaa.gov/dataviewer/
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pond Details Modal -->
    <div id="pondModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pondModalTitle">Pond Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="pondModalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <p></p>Loading pond details...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://ghew7mwudk326bla57wgqe5xxi0ymhjm.lambda-url.us-east-1.on.aws';
        const REFRESH_INTERVAL = 60000; // 60 seconds
        let refreshTimer = null;
        let map = null;

        // Tab switching
        function showTab(tabName, button) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (button) button.classList.add('active');

            // Load map when images tab is shown
            if (tabName === 'images' && !map) {
                setTimeout(() => initMap(), 500);
            }
        }

        // API Call Helper
        async function fetchAPI(pondName = null) {
            const url = pondName ? `${API_BASE}/?pond_name=${pondName}` : `${API_BASE}/`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return await response.json();
        }

        // Load System Overview
        async function loadSystemOverview() {
            const container = document.getElementById('systemStats');
            try {
                const ponds = ['atmospheric', 'oceanic', 'buoy', 'climate', 'terrestrial', 'spatial'];
                const data = await Promise.all(ponds.map(p => fetchAPI(p)));

                let html = '';
                const pondIcons = {
                    atmospheric: 'üå§Ô∏è',
                    oceanic: 'üåä',
                    buoy: '‚öì',
                    climate: 'üå°Ô∏è',
                    terrestrial: 'üåç',
                    spatial: 'üó∫Ô∏è'
                };

                data.forEach((pondData, idx) => {
                    const pondName = ponds[idx];
                    const recentData = pondData.recent_data || [];
                    const products = pondData.products_found || [];
                    const totalFiles = pondData.total_files_today || 0;
                    const growth = pondData.growth || 0;
                    const growthPct = pondData.growth_percentage || 0;
                    const lastUpdate = recentData[0]?.last_modified || 'N/A';

                    const growthColor = growth >= 0 ? '#2ecc71' : '#e74c3c';
                    const growthIcon = growth >= 0 ? 'üìà' : 'üìâ';
                    const growthText = growth >= 0 ? `+${growth.toLocaleString()}` : growth.toLocaleString();

                    html += `
                        <div class="stat-card">
                            <div class="stat-label">${pondIcons[pondName]} ${pondName.toUpperCase()}</div>
                            <div class="stat-value">${totalFiles.toLocaleString()}</div>
                            <div class="stat-change">Files Today</div>
                            <div class="stat-change" style="margin-top: 10px; color: ${growthColor};">
                                ${growthIcon} ${growthText} (${growthPct >= 0 ? '+' : ''}${growthPct}%)
                            </div>
                            <div class="stat-change" style="font-size: 0.85em; opacity: 0.8;">
                                ${products.length} products | ${lastUpdate !== 'N/A' ? new Date(lastUpdate).toLocaleTimeString() : 'Waiting...'}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error loading overview:', error);
                container.innerHTML = `<div class="error">Error loading system metrics: ${error.message}</div>`;
            }
        }

        // Load Data Ponds
        async function loadDataPonds() {
            const container = document.getElementById('pondsGrid');
            try {
                const ponds = [
                    { name: 'atmospheric', icon: 'üå§Ô∏è', desc: 'Weather observations, alerts, and forecasts' },
                    { name: 'oceanic', icon: 'üåä', desc: 'Tides, water levels, and ocean conditions' },
                    { name: 'buoy', icon: '‚öì', desc: 'Marine buoy observations and metadata' },
                    { name: 'climate', icon: 'üå°Ô∏è', desc: 'Historical climate data and trends' },
                    { name: 'terrestrial', icon: 'üåç', desc: 'River gauges and land observations' },
                    { name: 'spatial', icon: 'üó∫Ô∏è', desc: 'Geographic zones and radar stations' }
                ];

                const data = await Promise.all(ponds.map(p => fetchAPI(p.name)));

                let html = '';
                data.forEach((pondData, idx) => {
                    const pond = ponds[idx];
                    const recentData = pondData.recent_data || [];
                    const products = pondData.products_found || [];
                    const latestTime = recentData[0]?.last_modified || 'N/A';

                    html += `
                        <div class="pond-card" onclick="showPondDetails('${pond.name}')">
                            <div class="pond-header">
                                <span class="pond-icon">${pond.icon}</span>
                                <span class="pond-status">Active</span>
                            </div>
                            <div class="pond-title">${pond.name.charAt(0).toUpperCase() + pond.name.slice(1)}</div>
                            <p style="color: #999; margin-bottom: 15px; font-size: 0.9em;">${pond.desc}</p>
                            <div class="pond-stats">
                                <div><strong>Products:</strong> ${products.join(', ') || 'Loading...'}</div>
                                <div><strong>Recent Files:</strong> ${recentData.length}</div>
                                <div><strong>Latest:</strong> ${latestTime !== 'N/A' ? new Date(latestTime).toLocaleString() : 'N/A'}</div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading ponds:', error);
                container.innerHTML = `<div class="error">Error loading data ponds: ${error.message}</div>`;
            }
        }

        // Show Pond Details Modal
        async function showPondDetails(pondName) {
            const modal = document.getElementById('pondModal');
            const title = document.getElementById('pondModalTitle');
            const body = document.getElementById('pondModalBody');

            title.textContent = `${pondName.charAt(0).toUpperCase() + pondName.slice(1)} Pond Details`;
            body.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
            modal.classList.add('active');

            try {
                const data = await fetchAPI(pondName);
                const recentData = data.recent_data || [];
                const products = data.products_found || [];

                let html = `
                    <div class="success">‚úÖ Successfully loaded real-time data from AWS Lambda</div>

                    <div class="detail-section">
                        <h3>üìä Overview</h3>
                        <p><strong>Pond Name:</strong> ${pondName}</p>
                        <p><strong>Products Found:</strong> ${products.join(', ')}</p>
                        <p><strong>Recent Files:</strong> ${recentData.length}</p>
                        <p><strong>API Endpoint:</strong> ${API_BASE}/?pond_name=${pondName}</p>
                        <p><strong>Timestamp:</strong> ${data.timestamp || new Date().toISOString()}</p>
                    </div>

                    <div class="detail-section">
                        <h3>üìÑ Recent Data Samples</h3>
                `;

                recentData.slice(0, 3).forEach((sample, idx) => {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #667eea;">Sample ${idx + 1}</h4>
                            <p><strong>S3 Key:</strong> ${sample.key}</p>
                            <p><strong>Size:</strong> ${(sample.size / 1024).toFixed(2)} KB</p>
                            <p><strong>Last Modified:</strong> ${new Date(sample.last_modified).toLocaleString()}</p>
                            ${sample.data ? `
                                <p><strong>Data Preview:</strong></p>
                                <div class="data-sample">${JSON.stringify(sample.data, null, 2)}</div>
                            ` : ''}
                        </div>
                    `;
                });

                html += `</div>`;

                // Add location data for spatial pond
                if (pondName === 'spatial' && recentData.length > 0) {
                    const locationData = recentData.find(d => d.data && d.data.latitude);
                    if (locationData) {
                        const d = locationData.data;
                        html += `
                            <div class="detail-section">
                                <h3>üó∫Ô∏è Map Data Example</h3>
                                <div class="info-box">
                                    <strong>Location:</strong> ${d.location_name || 'N/A'}<br>
                                    <strong>Coordinates:</strong> ${d.latitude}, ${d.longitude}<br>
                                    <strong>Radar Station:</strong> ${d.radar_station || 'N/A'}<br>
                                    <strong>Grid:</strong> ${d.grid_id || 'N/A'} (${d.grid_x}, ${d.grid_y})<br><br>

                                    <strong>üéØ Frontend can use this to construct:</strong><br>
                                    ‚Ä¢ Radar Image: https://radar.weather.gov/ridge/standard/${d.radar_station || 'KBOX'}_loop.gif<br>
                                    ‚Ä¢ Forecast Data: ${d.forecast_url || 'N/A'}
                                </div>
                            </div>
                        `;
                    }
                }

                body.innerHTML = html;
            } catch (error) {
                console.error('Error loading pond details:', error);
                body.innerHTML = `<div class="error">Error loading pond details: ${error.message}</div>`;
            }
        }

        // Close Modal
        function closeModal() {
            document.getElementById('pondModal').classList.remove('active');
        }

        // Image load status
        function imageLoaded(imageId) {
            const statusId = imageId + 'Status';
            document.getElementById(statusId).innerHTML =
                '<span style="color: #2ecc71;">‚úÖ Image loaded successfully from NOAA servers</span>';
        }

        function imageError(imageId) {
            const statusId = imageId + 'Status';
            document.getElementById(statusId).innerHTML =
                '<span style="color: #e74c3c;">‚ö†Ô∏è Image temporarily unavailable</span>';
        }

        // Initialize Map
        async function initMap() {
            if (map) return;

            try {
                map = L.map('stationMap').setView([39.8283, -98.5795], 4);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Fetch spatial data
                const data = await fetchAPI('spatial');
                const locations = data.recent_data
                    .filter(d => d.data && d.data.latitude && d.data.longitude)
                    .slice(0, 10);

                locations.forEach(loc => {
                    const d = loc.data;
                    const marker = L.marker([d.latitude, d.longitude]);

                    const radarUrl = `https://radar.weather.gov/ridge/standard/${d.radar_station}_loop.gif`;

                    marker.bindPopup(`
                        <strong>${d.location_name || 'Station'}</strong><br>
                        Radar: ${d.radar_station || 'N/A'}<br>
                        <a href="${radarUrl}" target="_blank">View Radar</a>
                    `);

                    marker.addTo(map);
                });

                document.getElementById('mapStatus').innerHTML =
                    `<span style="color: #2ecc71;">‚úÖ Map loaded with ${locations.length} stations from spatial pond</span>`;
            } catch (error) {
                console.error('Map error:', error);
                document.getElementById('mapStatus').innerHTML =
                    `<span style="color: #e74c3c;">‚ö†Ô∏è ${error.message}</span>`;
            }
        }

        // Refresh All
        async function refreshAll() {
            console.log('Refreshing all data...');
            await Promise.all([
                loadSystemOverview(),
                loadDataPonds()
            ]);
        }

        // Auto-refresh
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(refreshAll, REFRESH_INTERVAL);
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Dashboard initializing...');
            await refreshAll();
            startAutoRefresh();
        });

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('pondModal');
            if (
event.target === modal) {
                modal.classList.remove("active");
            }
        };
    </script>
</body>
</html>
